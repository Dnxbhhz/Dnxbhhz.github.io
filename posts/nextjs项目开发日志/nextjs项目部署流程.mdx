---
title: 'nextjsé¡¹ç›®éƒ¨ç½²æµç¨‹'
date: '2025-07-12'
summary: 'nextjsé¡¹ç›®éƒ¨ç½²æµç¨‹'
---

## å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒ nextjs çš„äº§ç‰©åŒºåˆ«

Next.js ä¸­â€œé™æ€èµ„æºâ€çš„å‡ ç§ç±»å‹ï¼š

| ç±»å‹                          | æ”¾ç½®ä½ç½®                 | è®¿é—®è·¯å¾„                 | ç¤ºä¾‹                                        |
| ----------------------------- | ------------------------ | ------------------------ | ------------------------------------------- |
| **å…¬å¼€èµ„æºï¼ˆpublicï¼‰**        | `/public`                | `/xxx`                   | `/public/logo.png â†’ /logo.png`              |
| **æ„å»ºäº§ç‰©ï¼ˆ\_next/staticï¼‰** | è‡ªåŠ¨ç”Ÿæˆï¼Œæ”¾åœ¨å†…å­˜ä¸­     | `/_next/static/...`      | æ„å»ºæ—¶ç”Ÿæˆçš„ JSã€CSSã€å›¾ç‰‡ç­‰                |
| **é™æ€å¯¼å‡ºçš„é¡µé¢**            | SSG é¡µé¢è¾“å‡ºä¸º HTML æ–‡ä»¶ | è‡ªå®šä¹‰è·¯å¾„æˆ–åµŒå…¥æ„å»ºç›®å½• | `/about â†’ about.html`ï¼ˆä»…é™ `export` æ¨¡å¼ï¼‰ |

### å¼€å‘ç¯å¢ƒ

1. å†…éƒ¨å¯åŠ¨ä¸€ä¸ª **Node.js + Webpackï¼ˆæˆ– Turbopackï¼‰** çš„æœåŠ¡

2. æ‰€æœ‰é™æ€èµ„æºéƒ½æ˜¯**å†…å­˜ä¸­å®æ—¶ç”Ÿæˆ**ï¼Œä¸æ˜¯å†™åœ¨ç£ç›˜ä¸Šçš„
3. å…¬å¼€èµ„æº `public/` æ–‡ä»¶ç…§å¸¸è®¿é—®ï¼Œæ— éœ€æ‰“åŒ…
4. æ‰€æœ‰ JS/CSS/å›¾ç‰‡èµ„æºç”± `/_next/static/` è·¯å¾„åŠ¨æ€æä¾›

ç‰¹ç‚¹ï¼š

| ç‰¹æ€§                  | æ˜¯å¦æŒä¹…å­˜å‚¨  | è¯´æ˜                       |
| --------------------- | ------------- | -------------------------- |
| `public/` é™æ€èµ„æº    | âœ… æœ‰ç£ç›˜æ–‡ä»¶ | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç›´æ¥è¯»å–       |
| `/_next/static/` èµ„æº | âŒ æ— ç£ç›˜æ–‡ä»¶ | ä¸´æ—¶ç¼“å­˜äºå†…å­˜ä¸­ï¼Œå®æ—¶æ„å»º |

### ç”Ÿäº§ç¯å¢ƒ

| è·¯å¾„                   | è¯´æ˜                                   |
| ---------------------- | -------------------------------------- |
| `.next/static/chunks/` | å„é¡µé¢æŒ‰éœ€åŠ è½½çš„ JS chunk              |
| `.next/static/media/`  | ä½¿ç”¨ `import` çš„å›¾ç‰‡ã€å­—ä½“ç­‰é™æ€æ–‡ä»¶   |
| `public/`              | æ‰€æœ‰æ‰‹åŠ¨æ”¾çš„å…¬å¼€èµ„æºï¼Œä¸ä¼šå˜ï¼Œç›´æ¥æ‹·è´ |

æ„å»ºå®Œæˆåæ‰€æœ‰è¿™äº›èµ„æºå¯ä»¥é€šè¿‡ `/_next/static/xxx` è·¯å¾„è®¿é—®ï¼ŒNext.js ä¼šè‡ªå·±æä¾›è·¯ç”±å¤„ç†ã€‚

#### éƒ¨ç½²åçš„é™æ€èµ„æºåŠ è½½æµç¨‹ï¼š

1. ç”¨æˆ·è®¿é—®é¡µé¢ï¼ˆå¦‚ `/about`ï¼‰
2. æœåŠ¡ç«¯è¿”å› SSR æˆ– SSG æ¸²æŸ“é¡µé¢
3. é¡µé¢ä¸­ä¼šåŠ è½½ `/_next/static/...` çš„ JS å’Œ CSS
4. æµè§ˆå™¨è¯·æ±‚è¿™äº›èµ„æºï¼ŒNext.js æœåŠ¡ä¼šç›´æ¥è¿”å› `.next/static` ä¸‹çš„æ–‡ä»¶å†…å®¹
5. æ‰€æœ‰ `/public` ä¸‹èµ„æºï¼Œç»§ç»­é€šè¿‡ `/logo.png`ã€`/favicon.ico` ç­‰è·¯å¾„è®¿é—®

> é¡¹ç›® Logoã€å›¾æ ‡ç­‰å…¬å¼€èµ„æºå¯ä»¥æ”¾åœ¨ public ä¸‹ï¼Œè¿™æ ·å°±èƒ½ç›´æ¥é€šè¿‡`/logo.png`ã€`/favicon.ico`è¿™ç§æ–¹å¼è®¿é—®

#### ä¸ºä»€ä¹ˆæœ‰çš„æ—¶å€™ï¼Œæ‰§è¡Œ nextjs build åï¼Œå† run dev ä¼šæŠ¥é”™ï¼Œåˆ é™¤.next æ–‡ä»¶å°±æ­£å¸¸äº†ï¼Ÿ

å¼€å‘ç¯å¢ƒä¸‹ï¼Œè™½ç„¶å¤§éƒ¨åˆ†èµ„æºæ˜¯å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆï¼Œä½† è·¯ç”±ä¿¡æ¯ï¼Œæ„å»ºç¼“å­˜ï¼Œä»¥åŠæŸäº›ä¸´æ—¶æ–‡ä»¶ç­‰éƒ¨åˆ†ç¼“å­˜å’Œä¸­é—´äº§ç‰©ä¾ç„¶ä¼šå†™å…¥ .next æ–‡ä»¶å¤¹ï¼Œå¦‚æœ .next ç›®å½•è¢«ç”Ÿäº§ç¯å¢ƒçš„æ„å»ºäº§ç‰©æ±¡æŸ“ï¼Œå¼€å‘æœåŠ¡å™¨å¯èƒ½ä¼šè¯»å–åˆ°ä¸å…¼å®¹çš„å†…å®¹ï¼Œå¯¼è‡´æŠ¥é”™ã€‚

## éƒ¨ç½²æ–¹æ¡ˆä¸€ï¼šå‰åç«¯åˆ†ç¦»

### ä½¿ç”¨ nodejs éƒ¨ç½²

#### æœ¬åœ°æ‰“åŒ…æ–¹æ¡ˆ

åœ¨æœ¬åœ°æ‰§è¡Œ`npm run build`åï¼Œnextjs ä¼šç”Ÿæˆä¸€ä¸ª.next æ–‡ä»¶å¤¹ï¼Œå­˜æ”¾æ‰“åŒ…å¥½çš„æ–‡ä»¶ã€‚nextjs åŒ…å«äº†æ‰€æœ‰é¢„ç¼–è¯‘çš„é¡µé¢ã€æœåŠ¡ç«¯æ¸²æŸ“æ¨¡å—ç­‰ã€‚ä½†è¿è¡Œç”Ÿäº§æœåŠ¡ï¼ˆ`npm start` æˆ– `next start`ï¼‰æ—¶ï¼Œå®ƒä»ç„¶éœ€è¦ä»¥ä¸‹ä¸œè¥¿ï¼š

```lua
.next/                   æ„å»ºäº§ç‰©
public/                  é™æ€èµ„æº
package.json             å¯åŠ¨å’Œä¾èµ–å£°æ˜
package-lock.json        é”å®šä¾èµ–
scripts/deploy.sh        è„šæœ¬æ–‡ä»¶ï¼ˆå¯é€‰ä½†æ¨èï¼‰
.env.production          ç¯å¢ƒå˜é‡
next.config.js           é…ç½®æ–‡ä»¶ï¼ˆå¦‚ä½ è‡ªå®šä¹‰äº†ï¼‰
```

æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†æ‰€æœ‰éœ€è¦çš„ä¸œè¥¿æ‰“æˆä¸€ä¸ª.tar.gz çš„å‹ç¼©åŒ…

```sh
tar czf next-app.tar.gz \
  .next \
  public \
  package.json \
  package-lock.json \
  next.config.js \
  .env.production \
  scripts
```

> æ³¨æ„ï¼šå¦‚æœä½ ä¸ä¸Šä¼  `node_modules/`ï¼ŒæœåŠ¡å™¨ä¸Šè¦æ‰§è¡Œä¸€æ¬¡ `npm install`!!!!!

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å†™ä¸€ä¸ªéƒ¨ç½²è„šæœ¬äº†ã€‚

åœ¨é¡¹ç›®ä¸­æ·»åŠ  scripts æ–‡ä»¶å¤¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
your-nextjs-project/
â”œâ”€â”€ scripts/               â† å­˜æ”¾æ‰€æœ‰è„šæœ¬çš„ç›®å½•ï¼ˆæ¨èï¼‰
â”‚   â””â”€â”€ deploy.sh          â† è¿™æ˜¯éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ package.json
â”œâ”€â”€ .next/
â”œâ”€â”€ app/ æˆ– pages/
â””â”€â”€ ...
```

è„šæœ¬å†…å®¹ï¼š

```sh
#!/bin/bash

# å˜é‡
APP_NAME="next-app"
# /var/www/ æ˜¯ç³»ç»Ÿç›®å½•ï¼Œæ™®é€šç”¨æˆ·æ²¡æœ‰å†™æƒé™ï¼Œéœ€è¦ç¡®ä¿ç”¨æˆ·æœ‰æƒé™ï¼Œå¦åˆ™å¯ä»¥æ”¹ä¸ºç”¨æˆ·æ‹¥æœ‰æƒé™çš„ä½ç½®ï¼ˆå¦‚ /home/ubuntu/next-appï¼‰
DEPLOY_DIR="/var/www/$APP_NAME"
#éå¿…é¡»ï¼Œå¯ä»¥é€šè¿‡DEPLOY_USERè·å–å½“å‰æ‰§è¡Œäººï¼Œä½†ä¸€èˆ¬éƒ½ä½¿ç”¨rootç”¨æˆ·
DEPLOY_USER=$(whoami)

echo "ğŸš€ æ­£åœ¨éƒ¨ç½² Next.js åº”ç”¨åˆ° $DEPLOY_DIR"
echo "ğŸ‘¤ å½“å‰ç”¨æˆ·: $DEPLOY_USER"

# åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼Œå¦‚æœæœ‰è¯¥ç›®å½•ä¹Ÿä¸ä¼šè¢«è¦†ç›–
mkdir -p "$DEPLOY_DIR"

#ä¸æ¨è rm -rf "$DEPLOY_DIR" æ•´ä½“åˆ é™¤ï¼Œç›®å½•æƒé™å¯èƒ½ä¸¢å¤±
echo "ğŸ§¹ æ¸…ç†æ—§æ„å»ºæ–‡ä»¶..."
rm -rf "$DEPLOY_DIR/.next"
rm -rf "$DEPLOY_DIR/public"
rm -f "$DEPLOY_DIR/package.json"
rm -f "$DEPLOY_DIR/package-lock.json"
rm -f "$DEPLOY_DIR/next.config.js"
rm -f "$DEPLOY_DIR/.env.production"

# è§£å‹ä¸Šä¼ çš„åŒ…
echo "ğŸ“¦ è§£å‹ä¸Šä¼ æ–‡ä»¶..."
# ä¼šè¦†ç›–åŒåæ–‡ä»¶
tar -xzf next-app.tar.gz -C "$DEPLOY_DIR" --strip-components=1

cd "$DEPLOY_DIR"

# å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm install --omit=dev

# å¯åŠ¨åº”ç”¨ï¼ˆæ¨èä½¿ç”¨ pm2ï¼‰
if command -v pm2 &> /dev/null; then
  if pm2 list | grep -q "$APP_NAME"; then
    echo "ğŸ” æ­£åœ¨é‡å¯ $APP_NAME..."
    pm2 restart "$APP_NAME"
  else
    echo "ğŸš€ æ­£åœ¨å¯åŠ¨ $APP_NAME..."
    pm2 start npm --name "$APP_NAME" -- start
  fi
  pm2 save
else
  echo "âš ï¸ æœªå®‰è£… pm2ï¼Œå°†ç›´æ¥ä½¿ç”¨ npm å¯åŠ¨ï¼ˆéœ€ä¿æŒç»ˆç«¯æ‰“å¼€ï¼‰"
  npm start
fi

echo "âœ… éƒ¨ç½²å®Œæˆï¼ä½ ç°åœ¨å¯ä»¥è®¿é—®ä½ çš„æœåŠ¡äº†ã€‚"

```

#### æœåŠ¡å™¨éƒ¨ç½²æµç¨‹

å…·ä½“æ“ä½œæ­¥éª¤è§æˆ‘çš„æœåŠ¡å™¨ä¸Šä¼ ç™»å½•æµç¨‹

```sh
# ä¸Šä¼ å‹ç¼©åŒ…
scp next-app.tar.gz youruser@yourserver:/var/www/

# ç™»å½•æœåŠ¡å™¨
ssh youruser@yourserver

# è§£å‹å’Œæ‰§è¡Œéƒ¨ç½²è„šæœ¬
cd /var/www/
tar xzf next-app.tar.gz

# æœ‰è„šæœ¬çš„æƒ…å†µ, æ‰§è¡Œè„šæœ¬
cd next-app-dist/scripts/
# é¦–æ¬¡ç»™æ‰§è¡Œæƒé™ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
chmod +x deploy.sh
./deploy.sh

# æ²¡æœ‰è„šæœ¬çš„æƒ…å†µï¼Œæ‰‹åŠ¨æ‰§è¡Œï¼Œå’Œæœ‰è„šæœ¬çš„æƒ…å†µä¿ç•™ä¸€ä¸ªæ—¢å¯
# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæ²¡æœ‰ä¸Šä¼  node_modulesï¼‰
npm install
# å¯åŠ¨æœåŠ¡ï¼ˆæ¨èä½¿ç”¨ pm2ï¼‰
npm start         # æˆ– pm2 start npm --name next-app -- start

```

### git æ‹‰å–ä»£ç éƒ¨ç½²ï¼ˆåç»­å†å®Œå–„ï¼‰

æ›´æ”¹è„šæœ¬ï¼š

```sh
#!/bin/bash

# é¡¹ç›®é…ç½®
REPO_URL="git@github.com:user/next-app.git"
BRANCH="main"
APP_NAME="next-app"
DEPLOY_DIR="/var/www/$APP_NAME"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $APP_NAME"

# å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œå…‹éš†ï¼›å¦åˆ™æ‹‰å–æœ€æ–°
if [ ! -d "$DEPLOY_DIR" ]; then
  echo "ğŸ“¥ å…‹éš†ä»“åº“åˆ° $DEPLOY_DIR"
  git clone -b $BRANCH $REPO_URL "$DEPLOY_DIR"
else
  echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç "
  cd "$DEPLOY_DIR"
  git fetch origin $BRANCH
  git reset --hard origin/$BRANCH
fi

cd "$DEPLOY_DIR"

# å®‰è£…ä¾èµ–ï¼ˆåªå®‰è£…ç”Ÿäº§ä¾èµ–ï¼‰
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm install --omit=dev

# æ„å»ºé¡¹ç›®
echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
npm run build

# å¯åŠ¨æˆ–é‡å¯æœåŠ¡
if command -v pm2 &> /dev/null; then
  if pm2 list | grep -q "$APP_NAME"; then
    echo "ğŸ” é‡å¯æœåŠ¡..."
    pm2 restart "$APP_NAME"
  else
    echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
    pm2 start npm --name "$APP_NAME" -- start
  fi
  pm2 save
else
  echo "âš ï¸ æœªå®‰è£… pm2ï¼Œå°†ç›´æ¥å¯åŠ¨ï¼ˆéå®ˆæŠ¤ï¼‰"
  npm start
fi

echo "âœ… éƒ¨ç½²å®Œæˆï¼"

```

## éƒ¨ç½²æ–¹æ¡ˆäºŒ å‰ç«¯èµ„æºåµŒå…¥åˆ°åç«¯çš„ Java åº”ç”¨ä¸­

å¾ˆå¤š Java åç«¯é¡¹ç›®ï¼ˆå¦‚ä½¿ç”¨ Spring Bootï¼‰ä¸­å¸¸è§çš„ä¸€ç§éƒ¨ç½²æ–¹å¼ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å°†å‰ç«¯é™æ€èµ„æºï¼ˆå¦‚ Next.js æ„å»ºåçš„ HTMLã€JSã€CSS ç­‰ï¼‰ä½œä¸ºèµ„æºåµŒå…¥åˆ°åç«¯çš„ Java åº”ç”¨ä¸­**ï¼Œç„¶åé€šè¿‡åç«¯æ¥ç»Ÿä¸€å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ‰“æˆä¸€ä¸ªå¯æ‰§è¡Œçš„ `.jar` åŒ…ï¼Œç›´æ¥è¿è¡Œå³å¯éƒ¨ç½²ã€‚

è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š

1. å‰ç«¯æ„å»ºï¼ˆNext.jsï¼‰

   ä½ é¦–å…ˆè¿è¡Œï¼š

   ```
   npm run build
   ```

   ç„¶åè·å–æ„å»ºåçš„é™æ€èµ„æºï¼Œé€šå¸¸ä½äºï¼š

   ```
   .next/
   public/   â† é™æ€èµ„æºç›®å½•
   ```

   ä¸è¿‡ **Next.js æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ¡†æ¶**ï¼Œä¸åƒ Vue/React çš„çº¯å‰ç«¯ SPA æ„å»ºååªæœ‰é™æ€ HTML/JSï¼Œå®ƒéœ€è¦ Node æœåŠ¡æ¥è¿è¡Œã€‚

   > âš ï¸ æ‰€ä»¥é€šå¸¸ç”¨äºæ‰“è¿› `.jar` çš„å‰ç«¯é¡¹ç›®æ˜¯çº¯é™æ€é¡µé¢ï¼ˆæ¯”å¦‚ Vue CLIã€Vite æ„å»ºçš„é¡¹ç›®ï¼‰ï¼Œè€Œä¸æ˜¯ SSR çš„ Next.js é¡¹ç›®ï¼Œ**é™¤éä½ æŠŠ Next.js export æˆçº¯é™æ€ HTMLï¼ˆç”¨ `next export`ï¼‰**ã€‚

2. å°†å‰ç«¯é™æ€èµ„æºå¤åˆ¶åˆ° Java é¡¹ç›®çš„ `resources/static` ä¸­

   åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œæœ‰ä¸€ä¸ªç›®å½•ï¼š

   ```
   src/main/resources/static/
   ```

   ä½ å¯ä»¥æŠŠæ„å»ºå¥½çš„å‰ç«¯èµ„æºï¼ˆå¦‚ `out/` æˆ– `dist/`ï¼‰æ‹·è´è¿›å»ï¼š

   ```
   # ä¸¾ä¾‹ï¼šå°†å‰ç«¯æ„å»ºç»“æœå¤åˆ¶åˆ°åç«¯é™æ€ç›®å½•
   cp -r your-frontend-project/out/* your-springboot-project/src/main/resources/static/
   ```

   > Spring Boot ä¼šè‡ªåŠ¨å°† `static/` ä¸‹çš„èµ„æºæ˜ å°„ä¸º Web èµ„æºï¼Œç”¨æˆ·è®¿é—® `/` ä¼šåŠ è½½ä½ çš„å‰ç«¯é¦–é¡µã€‚

å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„ `.jar` æ–‡ä»¶ï¼Œåªéœ€ä½¿ç”¨ Java è¿è¡Œ jarï¼š`java -jar target/app-1.0.0.jar`, è¿™ä¸ª `.jar` æ˜¯ä¸€ä¸ªå®Œæ•´çš„ HTTP æœåŠ¡ï¼ˆå†…åµŒäº† Tomcatï¼‰ï¼Œä¼šç›‘å¬ç«¯å£ï¼Œæ¯”å¦‚ `http://localhost:8080`ã€‚

> æ³¨æ„ï¼šä»…é™ä½¿ç”¨ `next export` å°†é¡¹ç›®è½¬æˆçº¯é™æ€èµ„æºæ—¶ï¼š`npx next export`,ä¼šç”Ÿæˆä¸€ä¸ª `out/` æ–‡ä»¶å¤¹ï¼Œä½ å¯ä»¥æŠŠé‡Œé¢çš„æ–‡ä»¶å¤åˆ¶è¿› Spring Boot çš„ `static/`

## åç«¯ä»£ç†å‰ç«¯å¼€å‘ç¯å¢ƒ

æœ‰çš„æ—¶å€™ä¼šé‡åˆ°åç«¯æƒ³è¦ä»£ç†å‰ç«¯çš„å¼€å‘èµ·çš„æœåŠ¡ï¼Œç„¶åä¼šå‡ºç°è®¿é—®é™æ€èµ„æº 403ï¼Œè¿™æ˜¯å› ä¸ºï¼š

Next.js çš„ dev server é»˜è®¤æ˜¯**æŒ‰æ ¹è·¯å¾„ `/` æä¾›é™æ€èµ„æº**çš„ã€‚

> ä¸€æ—¦ä½ é€šè¿‡ä»£ç†è®©è®¿é—®è·¯å¾„å˜æˆäº† `/frontend/`ï¼Œè€Œåˆæ²¡é…ç½®å¯¹åº”çš„ **basePath**ï¼Œå‰ç«¯å°±æ‰¾ä¸åˆ°èµ„æºäº†ï¼Œæˆ–è€…æœåŠ¡ç«¯è¿”å› 403ï¼ˆç¦æ­¢è®¿é—®ï¼‰ã€‚

### è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `basePath` + ä»£ç†è½¬å‘é…ç½®åŒ¹é…

#### è®¾ç½® `next.config.js`

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  basePath: '/frontend', // ğŸ‘ˆ è®¾ç½®è®¿é—®å‰ç¼€
}

module.exports = nextConfig
```

è¿™æ ·æ‰€æœ‰é¡µé¢ã€é™æ€èµ„æºã€JS éƒ½ä¼šè‡ªåŠ¨ä»¥ `/frontend` ä¸ºå‰ç¼€ã€‚

> æ­¤æ—¶å¦‚æœéœ€è¦è®¿é—®/pubilc ç­‰å…¬å…±èµ„æºï¼Œä¹Ÿéœ€è¦åŠ ä¸Š`/frontend`

ä¾‹å¦‚ï¼š

- é¡µé¢å˜æˆ `/frontend`
- é™æ€èµ„æºå˜æˆ `/frontend/_next/static/xxx.js`

#### ç½‘å…³/åå‘ä»£ç†é…ç½®è½¬å‘ `/frontend` åˆ° `localhost:3000`

```nginx
location /frontend/ {
  proxy_pass http://localhost:3000/frontend/; # ğŸ‘ˆ ä¿ç•™ /frontend
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header Connection '';
  proxy_cache_bypass $http_upgrade;
}
```

> æ³¨æ„ï¼šä¸€å®š **ä¸è¦**å»æ‰ `/frontend/` è·¯å¾„ï¼Œå¦åˆ™å‰ç«¯çš„ basePath ä¼šæ‰¾ä¸åˆ°
>
> ```
> proxy_pass` åé¢ä¹Ÿè¦å¸¦ä¸Š `/frontend/
> ```

#### è®¿é—®åœ°å€

ä½ ç°åœ¨åº”è¯¥è®¿é—®ï¼šhttp://åç«¯ç½‘å…³ IP/frontendï¼Œå°±å¯ä»¥è®¿é—®åˆ° Next.js é¡µé¢ã€JSã€å›¾ç‰‡ç­‰é™æ€èµ„æºï¼Œ**ä¸å† 403 / 404**ã€‚

### ä¸ºä»€ä¹ˆä¸é€šè¿‡ç½‘å…³æˆ– nginx ä¸º `_next` é™æ€èµ„æºæ·»åŠ ä»£ç†ï¼Ÿ

1. èµ„æºè·¯å¾„å‰²è£‚: é¡µé¢è·¯å¾„æ˜¯ `/frontend`ï¼Œèµ„æºè·¯å¾„æ˜¯ `/_next`ï¼Œè·¯å¾„é€»è¾‘ä¸ä¸€è‡´
2. SSR è¿”å›çš„ HTML ä¸ä¸€è‡´: æœåŠ¡ç«¯è¿”å›çš„ HTML ä¸­èµ„æºå¼•ç”¨è·¯å¾„æ˜¯ `/_next/...`ï¼Œä½†é¡µé¢åœ¨ `/frontend` ä¸‹
3. ç¼ºå°‘ç»Ÿä¸€å‰ç¼€æ§åˆ¶: é¡µé¢å’Œèµ„æºåˆ†åˆ«é…ç½®ï¼Œä¸å¦‚ä½¿ç”¨ `basePath` ä¸€è‡´æ€§å¥½
4. æ³•ä»£ç†é™æ€æ–‡ä»¶å¦‚ `/favicon.ico`ã€`/robots.txt` ç­‰: å› ä¸ºè¿™äº›èµ„æºä¹Ÿè¦å•ç‹¬åŠ ä»£ç†æ‰ç”Ÿæ•ˆ

å› æ­¤ï¼Œæ¨èä½¿ç”¨ basePathï¼Œè‡ªåŠ¨è§£å†³è·¯å¾„å’Œèµ„æºæ˜ å°„é—®é¢˜

## åœ¨æœ¬åœ°è”è°ƒæ¥å£ï¼Œé…ç½®ä»£ç†

å‡è®¾æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°å¼€å‘æ—¶ï¼Œè°ƒè¯•æ¥å£ï¼Œå¹¶ä¸”åç«¯ä¼šä»£ç†æˆ‘ä»¬çš„æœåŠ¡ï¼Œæœ€åè¿˜éœ€è¦éƒ¨ç½²åˆ°çº¿ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å¤„ç†:

### ä¸€ã€ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ¥å£åœ°å€

```
.env.development     # å¼€å‘ç¯å¢ƒ
.env.production      # ç”Ÿäº§ç¯å¢ƒ
```

#### .env.development å’Œ .env.production æ–‡ä»¶åå¯ä»¥éšä¾¿æ”¹å—ï¼Ÿ

ä¸å¯ä»¥ï¼Next.jsï¼ˆä»¥åŠå¤§å¤šæ•° Node.js é¡¹ç›®ï¼‰ä¼šè‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹å‡ ç§ç¯å¢ƒå˜é‡æ–‡ä»¶åï¼š

- .envï¼ˆé€šç”¨ç¯å¢ƒå˜é‡ï¼‰

- .env.localï¼ˆæœ¬åœ°è¦†ç›–ï¼Œgit å¿½ç•¥ï¼‰

- .env.developmentï¼ˆå¼€å‘ç¯å¢ƒä¸“ç”¨ï¼‰

- .env.development.localï¼ˆå¼€å‘ç¯å¢ƒæœ¬åœ°è¦†ç›–ï¼‰

- .env.productionï¼ˆç”Ÿäº§ç¯å¢ƒä¸“ç”¨ï¼‰

- .env.production.localï¼ˆç”Ÿäº§ç¯å¢ƒæœ¬åœ°è¦†ç›–ï¼‰

#### é¡¹ç›®å¦‚ä½•åŒºåˆ†ç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒï¼Ÿ

Next.js é€šè¿‡ç¯å¢ƒå˜é‡ NODE_ENV æ¥åŒºåˆ†ï¼š

- NODE_ENV=developmentï¼šå¼€å‘ç¯å¢ƒï¼ˆnext dev æ—¶è‡ªåŠ¨è®¾ç½®ï¼‰

- NODE_ENV=productionï¼šç”Ÿäº§ç¯å¢ƒï¼ˆnext build å’Œ next start æ—¶è‡ªåŠ¨è®¾ç½®ï¼‰

åŠ è½½é¡ºåºï¼š

| è¿è¡Œç¯å¢ƒ | åŠ è½½é¡ºåºï¼ˆåè€…è¦†ç›–å‰è€…ï¼‰                                      |
| -------- | ------------------------------------------------------------- |
| å¼€å‘ç¯å¢ƒ | .env â†’ .env.local â†’ .env.development â†’ .env.development.local |
| ç”Ÿäº§ç¯å¢ƒ | .env â†’ .env.local â†’ .env.production â†’ .env.production.local   |

### äºŒã€é…ç½®æ¥å£ç¯å¢ƒå˜é‡

.env.development

```
NEXT_PUBLIC_API_BASE=/api
```

.env.production

```
# æœ‰nginxä»£ç†
NEXT_PUBLIC_API_BASE=/web
# æ²¡æœ‰nginxæˆ–è€…ç½‘å…³ä»£ç†å°±å†™çœŸå®åœ°å€
NEXT_PUBLIC_API_BASE=https://api.yourdomain.com
```

> å˜é‡åå¿…é¡»ä»¥ NEXT*PUBLIC* å¼€å¤´ï¼Œæ‰èƒ½åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­è®¿é—®
> EXT*PUBLIC* å‰ç¼€æ˜¯ Next.js çš„ä¸€ä¸ªå®‰å…¨æœºåˆ¶ï¼š
>
> - åªæœ‰ä»¥ NEXT*PUBLIC* å¼€å¤´çš„ç¯å¢ƒå˜é‡æ‰ä¼šè¢«æ³¨å…¥åˆ°å‰ç«¯ä»£ç 
>
> - å…¶ä»–ç¯å¢ƒå˜é‡åªèƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨ï¼Œä¸ä¼šæš´éœ²åˆ°å‰ç«¯
>
> è®©å¼€å‘è€…å¿…é¡»æ˜¾å¼å£°æ˜å“ªäº›ç¯å¢ƒå˜é‡æ˜¯å…¬å¼€çš„ï¼Œé¿å…æ„å¤–æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚

### ä¸‰ã€å°è£… Axios å®ä¾‹

```ts
import axios from 'axios'

const service = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE, // ğŸ‘ˆ ç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢
  timeout: 10000,
  withCredentials: true,
})
```

### å››ã€å¼€å‘ç¯å¢ƒï¼šé…åˆ rewrites å®ç°æ¥å£ä»£ç†

```js
const nextConfig = {
  async rewrites() {
    // ç”Ÿäº§ç¯å¢ƒä¸‹ä¹Ÿä¼šèµ°rewriteséœ€è¦åšåˆ¤æ–­
    if (process.env.NODE_ENV === 'development') {
      return [
        {
          source: '/api/:path*',
          destination: 'http://10.1.1.1:4000/:path*', // åç«¯çœŸå®è·¯å¾„ï¼ˆæ—  /apiï¼‰
        },
      ]
    }

    return []
  },
}

module.exports = nextConfig
```

å¼€å‘æ—¶å‰ç«¯è¯·æ±‚ `/api/user/info`ï¼ŒNext.js ä¼šè‡ªåŠ¨è½¬å‘åˆ°åç«¯ï¼Œæ— è·¨åŸŸã€‚

### äº”ã€ç”Ÿäº§ç¯å¢ƒé…åˆ nginx

```nginx
# å‡è®¾é¡µé¢è·¯å¾„æ˜¯ /webï¼ˆNext.js çš„ basePath å¯é€‰è®¾ç½®ï¼‰
location /web/ {
  proxy_pass http://localhost:3000/web/;
  proxy_set_header Host $host;
}

# å¦‚æœæ²¡é…ç½®basePath
 location / {
   proxy_pass http://localhost:3000;  # ä»£ç†åˆ° Next.js æœåŠ¡
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
  }
}


# æ¥å£è·¯å¾„ä¹Ÿæ˜¯ /web/xxxï¼Œä½†å®é™…è½¬å‘ä¸º /xxx
location ~ ^/web/(.*)$ {
  rewrite ^/web/(.*)$ /$1 break;
  proxy_pass http://10.1.1.1:4000;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
}
```

#### é€‰é…ï¼šå¦‚æœä½ å‰ç«¯é¡µé¢ä¹Ÿéƒ¨ç½²åœ¨ `/web` è·¯å¾„ä¸‹ï¼‰:

```js
// next.config.js
module.exports = {
  basePath: '/web',
  async rewrites() {
    const isDev = process.env.NODE_ENV === 'development'
    return isDev
      ? [
          {
            source: '/api/:path*',
            destination: 'http://10.1.1.1:4000/:path*',
          },
        ]
      : []
  },
}
```
